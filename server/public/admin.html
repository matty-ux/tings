<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vend GB Admin</title>
    <style>
      :root {
        --primary: #0f62fe; 
        --bg: #f7f9fc; 
        --text: #0f172a; 
        --muted: #6b7280; 
        --card: #ffffff; 
        --border: #e5e7eb; 
        --soft: #f1f5f9;
        --sidebar-bg: #ffffff;
        --sidebar-border: #e5e7eb;
      }
      [data-theme="dark"] {
        --primary: #4f8cff; 
        --bg: #0b1220; 
        --text: #e5e7eb; 
        --muted: #9ca3af; 
        --card: #0f172a; 
        --border: #1f2937; 
        --soft: #111827;
        --sidebar-bg: #0f172a;
        --sidebar-border: #1f2937;
      }
      
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { 
        font-family: -apple-system, system-ui, Helvetica, Arial, sans-serif; 
        background: var(--bg); 
        color: var(--text);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      
      /* Sidebar */
      .sidebar {
        width: 280px;
        background: var(--sidebar-bg);
        border-right: 1px solid var(--sidebar-border);
        padding: 20px;
        overflow-y: auto;
        flex-shrink: 0;
      }
      
      .sidebar h1 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 20px;
      }
      
      .status {
        padding: 8px 12px;
        background: #e5f4ea;
        color: #256c2d;
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 20px;
      }
      
      .server-info {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
        font-size: 12px;
      }
      
      .server-info h3 {
        margin-bottom: 8px;
        color: var(--primary);
      }
      
      .server-info p {
        margin: 4px 0;
        color: var(--muted);
      }
      
      .btn {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--card);
        cursor: pointer;
        transition: .2s ease;
        color: var(--text);
        text-decoration: none;
        display: inline-block;
        font-size: 12px;
        margin: 4px 0;
        width: 100%;
        text-align: left;
      }
      
      .btn:hover {
        background: var(--soft);
        transform: translateY(-1px);
      }
      
      .btn.primary {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      
      .btn.primary:hover {
        background: #0043ce;
      }
      
      /* Main Content */
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      
      .toolbar .left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      
      .toolbar .right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .search-input {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--card);
        color: var(--text);
        min-width: 200px;
      }
      
      .select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--card);
        color: var(--text);
      }
      
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      }
      
      table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        margin-top: 12px;
        background: var(--card);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border);
      }
      
      thead th {
        position: sticky;
        top: 0;
        background: var(--soft);
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        color: var(--muted);
        padding: 12px;
      }
      
      td {
        border-bottom: 1px solid var(--border);
        padding: 12px;
        vertical-align: top;
      }
      
      tbody tr:hover {
        background: rgba(15,98,254,0.05);
      }
      
      .badge {
        padding: 2px 8px;
        border-radius: 999px;
        background: #e5f4ea;
        color: #256c2d;
        font-size: 12px;
      }
      
      .pill {
        display: inline-block;
        padding: 4px 8px;
        background: #eef2ff;
        color: #3730a3;
        border-radius: 999px;
        font-size: 12px;
        margin-right: 6px;
      }
      
      .hint {
        color: var(--muted);
        font-size: 12px;
      }
      
      .inline {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      
      .modal {
        width: 95%;
        max-width: 800px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        color: var(--text);
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }
      
      .col-6 { grid-column: span 6; }
      .col-12 { grid-column: span 12; }
      
      .close {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--text);
        float: right;
      }
      
      input[type="text"], input[type="number"], textarea, select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--card);
        color: var(--text);
        width: 100%;
      }
      
      textarea {
        min-height: 60px;
        resize: vertical;
      }
      
      label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        font-size: 13px;
      }
      
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
        justify-content: space-between;
      }
      
      /* Toast */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--card);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,.15);
        display: none;
        z-index: 1001;
      }
      
      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }
        
        .sidebar {
          width: 100%;
          height: auto;
          border-right: none;
          border-bottom: 1px solid var(--sidebar-border);
        }
        
        .toolbar .left {
          flex-direction: column;
          align-items: stretch;
        }
        
        .search-input {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h1>üõ†Ô∏è Vend GB Admin</h1>
      <div class="status">‚úÖ Server Online</div>
      
      <div class="server-info">
        <h3>Server Status</h3>
        <p><strong>Environment:</strong> <span id="environment">production</span></p>
        <p><strong>Uptime:</strong> <span id="uptime">0</span>s</p>
        <p><strong>Region:</strong> Railway EU</p>
      </div>
      
      <div class="server-info">
        <h3>Navigation</h3>
        <button class="btn" onclick="showProducts()">üì¶ Products</button>
        <button class="btn" onclick="showOrders()">üìã Orders</button>
        <button class="btn" onclick="showAccount()">üë§ Account</button>
        <button class="btn" onclick="logout()" style="background-color: #dc3545; color: white;">üö™ Logout</button>
      </div>
      
      <div class="server-info">
        <h3>Quick Actions</h3>
        <a href="/api/products" class="btn" target="_blank">üì± Products API</a>
        <a href="/api/admin/orders" class="btn" target="_blank">üì¶ Orders API</a>
        <a href="/health" class="btn" target="_blank">‚ù§Ô∏è Health Check</a>
        <button class="btn" onclick="toggleTheme()">üåô Toggle Theme</button>
        <button class="btn" onclick="refresh()">üîÑ Refresh Data</button>
      </div>
      
      <div class="server-info">
        <h3>Statistics</h3>
        <p><strong>Products:</strong> <span id="productCount">-</span></p>
        <p><strong>Orders:</strong> <span id="orderCount">-</span></p>
        <p><strong>Active:</strong> <span id="activeProducts">-</span></p>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Products View -->
      <div id="productsView">
        <div class="toolbar">
          <div class="left">
            <h1>Products</h1>
            <input id="search" type="text" class="search-input" placeholder="Search products...">
            <select id="categoryFilter" class="select">
              <option value="">All categories</option>
            </select>
            <select id="availFilter" class="select">
              <option value="">All availability</option>
              <option value="in">In stock</option>
              <option value="out">Out of stock</option>
            </select>
          </div>
          <div class="right">
            <button class="btn primary" onclick="openModal()">+ Add Product</button>
          </div>
        </div>

        <div class="card">
          <table id="productsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Orders View -->
      <div id="ordersView" style="display: none;">
        <div class="toolbar">
          <div class="left">
            <h1>Orders</h1>
            <input id="orderSearch" type="text" class="search-input" placeholder="Search orders...">
            <select id="statusFilter" class="select">
              <option value="">All statuses</option>
              <option value="new">New</option>
              <option value="accepted">Accepted</option>
              <option value="preparing">Preparing</option>
              <option value="out_for_delivery">Out for Delivery</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="right">
            <button class="btn" onclick="refreshOrders()">üîÑ Refresh Orders</button>
          </div>
        </div>

        <div class="card">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Account View -->
      <div id="accountView" style="display: none;">
        <div class="toolbar">
          <div class="left">
            <h1>Account Settings</h1>
          </div>
          <div class="right">
            <button class="btn" onclick="refresh()">üîÑ Refresh</button>
          </div>
        </div>

        <div class="card">
          <h2>üë§ User Account</h2>
          <p class="hint" style="margin-bottom: 20px;">Account management features coming soon. For now, you can manage your theme preferences.</p>
          
          <div style="margin-bottom: 20px;">
            <h3>Theme Preferences</h3>
            <p style="margin-bottom: 12px;">Choose your preferred theme for the admin dashboard:</p>
            <button class="btn primary" onclick="toggleTheme()" style="width: auto; margin-right: 10px;">
              <span id="themeIcon">üåô</span> Toggle Theme
            </button>
            <span id="currentTheme" class="hint">Current: Light Mode</span>
          </div>

          <div style="margin-bottom: 20px;">
            <h3>Account Information</h3>
            <div style="background: var(--soft); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
              <p><strong>Status:</strong> <span class="badge" style="background: #fee2e2; color: #dc2626;">Guest Access</span></p>
              <p><strong>Permissions:</strong> Full Admin Access</p>
              <p><strong>Login Method:</strong> Direct Access (No Authentication Required)</p>
              <p><strong>Last Active:</strong> <span id="lastActive">Just now</span></p>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h3>Security Settings</h3>
            <div style="background: var(--soft); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
              <p><strong>Authentication:</strong> <span class="badge" style="background: #fef3c7; color: #d97706;">Disabled</span></p>
              <p><strong>Two-Factor Auth:</strong> <span class="badge" style="background: #fef3c7; color: #d97706;">Not Available</span></p>
              <p><strong>Session Management:</strong> <span class="badge" style="background: #fef3c7; color: #d97706;">Not Implemented</span></p>
              <p class="hint" style="margin-top: 8px;">User authentication will be implemented in a future update.</p>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h3>Account Actions</h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn" onclick="exportData()" style="width: auto;">
                üì• Export Data
              </button>
              <button class="btn" onclick="viewLogs()" style="width: auto;">
                üìã View Logs
              </button>
              <button class="btn" onclick="clearCache()" style="width: auto;">
                üóëÔ∏è Clear Cache
              </button>
            </div>
          </div>

          <div>
            <h3>System Information</h3>
            <div style="background: var(--soft); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
              <p><strong>Server Version:</strong> 1.0.0</p>
              <p><strong>Database:</strong> JSON File Storage</p>
              <p><strong>Environment:</strong> <span id="accountEnvironment">production</span></p>
              <p><strong>Last Backup:</strong> <span id="lastBackup">Never</span></p>
              <p><strong>Storage Used:</strong> <span id="storageUsed">Calculating...</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    
    <!-- Modal -->
    <div id="modal" class="modal-backdrop">
      <div class="modal">
        <div class="row">
          <h2 id="modalTitle">New Product</h2>
          <button class="close" onclick="closeModal()">√ó</button>
        </div>
        <form id="productForm" onsubmit="addProduct(event)">
          <div class="grid">
            <div class="col-6">
              <label>SKU / Item Code</label>
              <input id="sku" type="text" placeholder="SKU">
            </div>
            <div class="col-6">
              <label>Sort Order</label>
              <input id="sortOrder" type="number" placeholder="0">
            </div>
            <div class="col-12">
              <label>Product Name *</label>
              <input id="name" type="text" required placeholder="Product name">
            </div>
            <div class="col-6">
              <label>Category</label>
              <input id="category" type="text" placeholder="e.g., Pizza">
            </div>
            <div class="col-6">
              <label>Tags (comma separated)</label>
              <input id="tags" type="text" placeholder="vegan, spicy">
            </div>
            <div class="col-12">
              <label>Short Description</label>
              <input id="shortDesc" type="text" placeholder="Brief description">
            </div>
            <div class="col-12">
              <label>Full Description</label>
              <textarea id="fullDesc" placeholder="Detailed description"></textarea>
            </div>
            <div class="col-6">
              <label>Base Price *</label>
              <input id="price" type="number" step="0.01" required placeholder="0.00">
            </div>
            <div class="col-6">
              <label>Sale Price</label>
              <input id="salePrice" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="col-6">
              <label>Cost Price</label>
              <input id="costPrice" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="col-6">
              <label>Tax Rate %</label>
              <input id="taxRate" type="number" step="0.01" placeholder="0">
            </div>
            <div class="col-6">
              <label>Image URL</label>
              <input id="imageUrl" type="text" placeholder="https://...">
            </div>
            <div class="col-6">
              <label>Stock Quantity</label>
              <input id="stockQty" type="number" placeholder="0">
            </div>
            <div class="col-6">
              <label>Max Order Qty</label>
              <input id="maxOrderQty" type="number" placeholder="0">
            </div>
            <div class="col-6">
              <label>Prep Time (mins)</label>
              <input id="prepTimeMins" type="number" placeholder="0">
            </div>
            <div class="col-6">
              <label>
                <input id="available" type="checkbox" checked> Available
              </label>
            </div>
            <div class="col-6">
              <label>
                <input id="active" type="checkbox" checked> Active
              </label>
            </div>
            <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
              <button type="button" class="btn" onclick="closeModal()">Cancel</button>
              <button id="submitBtn" type="submit" class="btn primary">Create</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <script>
const api = '/api/admin/products';
let _allProducts = [];
let _allOrders = [];
let currentEditId = null;
let currentView = 'products';

async function refresh() {
  if (currentView === 'products') {
    try {
      const res = await fetch('/api/admin/products');
      const data = await res.json();
      _allProducts = data;
      populateCategoryOptions(data);
      updateStats(data);
      render();
    } catch (error) {
      console.error('Failed to fetch products:', error);
      toast('Error loading products');
    }
  } else if (currentView === 'orders') {
    refreshOrders();
  } else if (currentView === 'account') {
    updateAccountInfo();
  }
}

function updateStats(products = null) {
  if (products) {
    document.getElementById('productCount').textContent = products.length;
    document.getElementById('activeProducts').textContent = products.filter(p => p.active).length;
  }
  
  // Update order count
  if (_allOrders.length > 0) {
    document.getElementById('orderCount').textContent = _allOrders.length;
  } else {
    fetch('/api/admin/orders')
      .then(res => res.json())
      .then(orders => {
        document.getElementById('orderCount').textContent = orders.length;
      })
      .catch(() => {
        document.getElementById('orderCount').textContent = '-';
      });
  }
}

function render() {
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = '';
  const q = (document.getElementById('search').value || '').toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const avail = document.getElementById('availFilter').value;
  
  const data = _allProducts.filter(p => {
    const inText = (p.name + ' ' + (p.sku||'') + ' ' + (p.tags||[]).join(' ')).toLowerCase().includes(q);
    const inCat = !cat || (p.category||'') === cat;
    const inAvail = !avail || (avail === 'in' ? p.available : !p.available);
    return inText && inCat && inAvail;
  });
  
  for (const p of data) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <strong>${p.name}</strong>
        <div class="hint">${p.sku || 'No SKU'} ${p.category ? '‚Ä¢ ' + p.category : ''}</div>
        ${p.tags && p.tags.length ? '<div>' + p.tags.map(t => '<span class="pill">' + t + '</span>').join('') + '</div>' : ''}
      </td>
      <td>
        <strong>¬£${p.price}</strong>
        ${p.salePrice ? '<div class="hint">Sale: ¬£' + p.salePrice + '</div>' : ''}
      </td>
      <td>
        <span class="badge">${p.stockQty || 0} in stock</span>
      </td>
      <td>
        <div class="inline">
          <label><input type="checkbox" ${p.available ? 'checked' : ''} onchange="update('${p.id}',{available:this.checked})"> Available</label>
          <label><input type="checkbox" ${p.active ? 'checked' : ''} onchange="update('${p.id}',{active:this.checked})"> Active</label>
        </div>
      </td>
      <td>
        <button class="btn" onclick="openEdit('${p.id}')">Edit</button>
        <button class="btn" onclick="del('${p.id}')" style="background: #dc2626; color: white; border-color: #dc2626;">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function openModal() { openModalForCreate(); }

function openModalForCreate() {
  currentEditId = null;
  document.getElementById('modalTitle').textContent = 'New Product';
  document.getElementById('submitBtn').textContent = 'Create';
  document.getElementById('productForm').reset();
  document.getElementById('available').checked = true;
  document.getElementById('active').checked = true;
  document.getElementById('modal').style.display = 'flex';
}

function openEdit(id) {
  const p = _allProducts.find(x => x.id === id);
  if (!p) return;
  currentEditId = id;
  document.getElementById('modalTitle').textContent = 'Edit Product';
  document.getElementById('submitBtn').textContent = 'Save';
  const form = document.getElementById('productForm');
  form.querySelector('#sku').value = p.sku || '';
  form.querySelector('#sortOrder').value = p.sortOrder ?? 0;
  form.querySelector('#name').value = p.name || '';
  form.querySelector('#category').value = p.category || '';
  form.querySelector('#tags').value = (p.tags||[]).join(', ');
  form.querySelector('#shortDesc').value = p.shortDesc || '';
  form.querySelector('#fullDesc').value = p.fullDesc || '';
  form.querySelector('#price').value = p.price ?? '';
  form.querySelector('#salePrice').value = p.salePrice ?? '';
  form.querySelector('#costPrice').value = p.costPrice ?? '';
  form.querySelector('#taxRate').value = p.taxRate ?? 0;
  form.querySelector('#imageUrl').value = p.imageUrl || '';
  form.querySelector('#stockQty').value = p.stockQty ?? 0;
  form.querySelector('#maxOrderQty').value = p.maxOrderQty ?? 0;
  form.querySelector('#prepTimeMins').value = p.prepTimeMins ?? 0;
  form.querySelector('#available').checked = !!p.available;
  form.querySelector('#active').checked = p.active !== false;
  document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

async function addProduct(e) {
  e?.preventDefault?.();
  const form = document.getElementById('productForm');
  const get = id => form.querySelector('#'+id);
  const name = get('name').value;
  const price = parseFloat(get('price').value);
  if (!name || Number.isNaN(price)) return alert('Name and price required');
  
  const payload = {
    sku: get('sku').value,
    name,
    shortDesc: get('shortDesc').value,
    fullDesc: get('fullDesc').value,
    category: get('category').value,
    tags: get('tags').value.split(',').map(s=>s.trim()).filter(Boolean),
    price,
    salePrice: (() => { const v = get('salePrice').value; return v === '' ? null : (Number.isNaN(parseFloat(v)) ? null : parseFloat(v)); })(),
    imageUrl: get('imageUrl').value,
    images: [],
    costPrice: (() => { const v = get('costPrice').value; return v === '' ? 0 : (Number.isNaN(parseFloat(v)) ? 0 : parseFloat(v)); })(),
    available: get('available').checked,
    taxRate: (() => { const v = get('taxRate').value; return v === '' ? 0 : (Number.isNaN(parseFloat(v)) ? 0 : parseFloat(v)); })(),
    stockQty: (() => { const v = get('stockQty').value; return v === '' ? 0 : (Number.isNaN(parseInt(v)) ? 0 : parseInt(v)); })(),
    maxOrderQty: (() => { const v = get('maxOrderQty').value; return v === '' ? 0 : (Number.isNaN(parseInt(v)) ? 0 : parseInt(v)); })(),
    prepTimeMins: (() => { const v = get('prepTimeMins').value; return v === '' ? 0 : (Number.isNaN(parseInt(v)) ? 0 : parseInt(v)); })(),
    active: get('active').checked,
    sortOrder: (() => { const v = get('sortOrder').value; return v === '' ? 0 : (Number.isNaN(parseInt(v)) ? 0 : parseInt(v)); })()
  };
  
  try {
    if (!currentEditId) {
      const res = await fetch('/api/admin/products', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('Create failed');
      toast('Product created successfully');
    } else {
      const res = await fetch(`/api/admin/products/${currentEditId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('Save failed');
      toast('Product saved successfully');
    }
  } catch (e) {
    console.error(e);
    toast('Error saving product');
    return;
  }
  closeModal();
  form.reset();
  refresh();
}

async function update(id, payload) {
  try {
    const res = await fetch(`/api/admin/products/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok) throw new Error('Save failed');
    toast('Updated');
    refresh();
  } catch (e) {
    console.error(e);
    toast('Error updating');
  }
}

async function del(id) {
  if (!confirm('Delete this product?')) return;
  try {
    await fetch(`/api/admin/products/${id}`, { method: 'DELETE' });
    toast('Product deleted');
    refresh();
  } catch (e) {
    console.error(e);
    toast('Error deleting product');
  }
}

function populateCategoryOptions(data) {
  const sel = document.getElementById('categoryFilter');
  const current = sel.value;
  const cats = Array.from(new Set((data||[]).map(p => p.category).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">All categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
  if (Array.from(sel.options).some(o => o.value === current)) sel.value = current;
}

function toggleTheme() {
  const next = (document.documentElement.getAttribute('data-theme') === 'dark') ? '' : 'dark';
  if (next) {
    document.documentElement.setAttribute('data-theme','dark');
    document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
    document.getElementById('currentTheme').textContent = 'Current: Dark Mode';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('themeIcon').textContent = 'üåô';
    document.getElementById('currentTheme').textContent = 'Current: Light Mode';
  }
  localStorage.setItem('theme', next);
  toast(`Switched to ${next ? 'Dark' : 'Light'} Mode`);
}

// Account functions
function updateAccountInfo() {
  // Update last active time
  document.getElementById('lastActive').textContent = new Date().toLocaleString();
  
  // Update environment
  document.getElementById('accountEnvironment').textContent = window.location.hostname.includes('railway') ? 'Production' : 'Development';
  
  // Update theme display
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('currentTheme').textContent = isDark ? 'Current: Dark Mode' : 'Current: Light Mode';
  
  // Calculate storage (mock for now)
  calculateStorageUsage();
}

function calculateStorageUsage() {
  // Mock storage calculation
  const productsCount = _allProducts.length;
  const ordersCount = _allOrders.length;
  const estimatedSize = (productsCount * 0.5) + (ordersCount * 2); // KB
  document.getElementById('storageUsed').textContent = `${estimatedSize.toFixed(1)} KB`;
}

function exportData() {
  const data = {
    products: _allProducts,
    orders: _allOrders,
    exportDate: new Date().toISOString(),
    version: '1.0.0'
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vend-gb-data-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Data exported successfully');
}

function viewLogs() {
  // Mock logs view
  const logs = [
    { time: new Date().toLocaleString(), level: 'INFO', message: 'Admin dashboard accessed' },
    { time: new Date(Date.now() - 300000).toLocaleString(), level: 'INFO', message: 'Products refreshed' },
    { time: new Date(Date.now() - 600000).toLocaleString(), level: 'INFO', message: 'Server health check passed' }
  ];
  
  const logsText = logs.map(log => `[${log.time}] ${log.level}: ${log.message}`).join('\n');
  alert(`Recent Logs:\n\n${logsText}\n\nNote: This is a mock log view. Real logging will be implemented with user authentication.`);
}

function clearCache() {
  if (confirm('Clear local cache? This will reset your theme preferences and any cached data.')) {
    localStorage.clear();
    toast('Cache cleared successfully');
    // Reload page to reset everything
    setTimeout(() => window.location.reload(), 1000);
  }
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 2000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Load theme
  const t = localStorage.getItem('theme');
  if (t === 'dark') document.documentElement.setAttribute('data-theme','dark');
  
  // Update uptime every second
  setInterval(() => {
    fetch('/health')
      .then(res => res.json())
      .then(data => {
        document.getElementById('uptime').textContent = Math.floor(data.uptime);
      })
      .catch(() => {});
  }, 1000);
  
  // Check authentication status first
  checkAuthStatus().then(() => {
    // Load data after authentication check
    refresh();
  });
});

// Authentication functions
async function checkAuthStatus() {
  try {
    const response = await fetch('/api/user');
    const userInfo = await response.json();
    
    if (userInfo.authenticated) {
      // Display user info in the sidebar
      const userInfoDiv = document.createElement('div');
      userInfoDiv.className = 'server-info';
      userInfoDiv.innerHTML = `
        <h3>User Info</h3>
        <p><strong>Name:</strong> ${userInfo.user.name}</p>
        <p><strong>Email:</strong> ${userInfo.user.email}</p>
      `;
      
      // Insert user info after server status
      const sidebar = document.querySelector('.sidebar');
      const serverInfo = sidebar.querySelector('.server-info');
      sidebar.insertBefore(userInfoDiv, serverInfo.nextSibling);
    } else {
      // Redirect to login if not authenticated
      window.location.href = '/login';
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    window.location.href = '/login';
  }
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    window.location.href = '/logout';
  }
}

// Navigation functions
function showProducts() {
  currentView = 'products';
  document.getElementById('productsView').style.display = 'block';
  document.getElementById('ordersView').style.display = 'none';
  document.getElementById('accountView').style.display = 'none';
  refresh();
}

function showOrders() {
  currentView = 'orders';
  document.getElementById('productsView').style.display = 'none';
  document.getElementById('ordersView').style.display = 'block';
  document.getElementById('accountView').style.display = 'none';
  refreshOrders();
}

function showAccount() {
  currentView = 'account';
  document.getElementById('productsView').style.display = 'none';
  document.getElementById('ordersView').style.display = 'none';
  document.getElementById('accountView').style.display = 'block';
  updateAccountInfo();
}

// Orders functions
async function refreshOrders() {
  try {
    const res = await fetch('/api/admin/orders');
    const data = await res.json();
    _allOrders = data;
    updateStats();
    renderOrders();
  } catch (error) {
    console.error('Failed to fetch orders:', error);
    toast('Error loading orders');
  }
}

function renderOrders() {
  const tbody = document.querySelector('#ordersTable tbody');
  tbody.innerHTML = '';
  const q = (document.getElementById('orderSearch').value || '').toLowerCase();
  const status = document.getElementById('statusFilter').value;
  
  const data = _allOrders.filter(o => {
    const inText = (o.id + ' ' + (o.customer?.name || '') + ' ' + (o.customer?.phone || '')).toLowerCase().includes(q);
    const inStatus = !status || o.status === status;
    return inText && inStatus;
  });
  
  for (const order of data) {
    const tr = document.createElement('tr');
    const itemsText = order.items?.map(item => `${item.qty}x ${item.name}`).join(', ') || 'No items';
    const date = new Date(order.createdAt).toLocaleDateString();
    const time = new Date(order.createdAt).toLocaleTimeString();
    
    tr.innerHTML = `
      <td>
        <strong>${order.id.substring(0, 8)}...</strong>
        <div class="hint">${time}</div>
      </td>
      <td>
        <strong>${order.customer?.name || 'Unknown'}</strong>
        <div class="hint">${order.customer?.phone || 'No phone'}</div>
      </td>
      <td>
        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
          ${itemsText}
        </div>
      </td>
      <td>
        <strong>¬£${order.total}</strong>
      </td>
      <td>
        <select onchange="updateOrderStatus('${order.id}', this.value)" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--card); color: var(--text);">
          <option value="new" ${order.status === 'new' ? 'selected' : ''}>New</option>
          <option value="accepted" ${order.status === 'accepted' ? 'selected' : ''}>Accepted</option>
          <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
          <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
          <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
          <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
        </select>
      </td>
      <td>
        ${date}
      </td>
      <td>
        <button class="btn" onclick="viewOrderDetails('${order.id}')" style="font-size: 11px; padding: 4px 8px;">View</button>
        <button class="btn" onclick="deleteOrder('${order.id}')" style="background: #dc2626; color: white; border-color: #dc2626; font-size: 11px; padding: 4px 8px;">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

async function updateOrderStatus(orderId, newStatus) {
  try {
    const res = await fetch(`/api/admin/orders/${orderId}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ status: newStatus })
    });
    if (!res.ok) throw new Error('Update failed');
    toast(`Order status updated to ${newStatus}`);
    refreshOrders();
  } catch (e) {
    console.error(e);
    toast('Error updating order status');
  }
}

function viewOrderDetails(orderId) {
  const order = _allOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const itemsList = order.items?.map(item => 
    `‚Ä¢ ${item.qty}x ${item.name} - ¬£${item.price} each`
  ).join('\n') || 'No items';
  
  const address = order.address ? 
    `${order.address.line1}\n${order.address.line2}\n${order.address.city} ${order.address.postcode}` : 
    'No address';
  
  alert(`Order Details: ${orderId}

Customer: ${order.customer?.name || 'Unknown'}
Phone: ${order.customer?.phone || 'Not provided'}

Address:
${address}

Items:
${itemsList}

Total: ¬£${order.total}
Status: ${order.status}
Notes: ${order.notes || 'None'}
Created: ${new Date(order.createdAt).toLocaleString()}`);
}

async function deleteOrder(orderId) {
  if (!confirm('Delete this order? This cannot be undone.')) return;
  try {
    const res = await fetch(`/api/admin/orders/${orderId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('Delete failed');
    toast('Order deleted');
    refreshOrders();
  } catch (e) {
    console.error(e);
    toast('Error deleting order');
  }
}

// Event listeners
document.getElementById('search').addEventListener('input', render);
document.getElementById('categoryFilter').addEventListener('change', render);
document.getElementById('availFilter').addEventListener('change', render);
document.getElementById('orderSearch').addEventListener('input', renderOrders);
document.getElementById('statusFilter').addEventListener('change', renderOrders);
    </script>
  </body>
</html>
